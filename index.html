<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Telegram Web Apps SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <title>Digital Goods Shop</title>
  <style>
    :root {
      --accent: #229ED9;
      --accent-dark: #1976a5;
      --radius: 16px;
      --shadow: 0 4px 16px rgba(34,158,217,0.08);
      --star-size: 1.1em;
      font-family: 'SF Pro Display', 'Inter', system-ui, sans-serif;
    }
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f6f7f9 0%, #eaf6fb 100%);
      color: #111;
      min-height: 100vh;
    }
    h1 {
      font-size: 1.5rem;
      margin: 0 0 18px;
      font-weight: 700;
      letter-spacing: -0.5px;
      color: var(--accent);
      text-align: center;
    }
    #list {
      max-width: 420px;
      margin: 0 auto;
    }
    .card {
      background: #fff;
      border-radius: var(--radius);
      padding: 20px 18px 18px 18px;
      margin-bottom: 18px;
      box-shadow: var(--shadow);
      transition: box-shadow 0.2s;
      border: 1px solid #e3eaf1;
    }
    .card:hover {
      box-shadow: 0 8px 32px rgba(34,158,217,0.13);
      border-color: #d0e6f7;
    }
    .title {
      font-weight: 600;
      font-size: 1.13rem;
      margin-bottom: 4px;
      color: #222;
    }
    .desc {
      font-size: .97rem;
      margin: 8px 0 18px;
      color: #4a4a4a;
      line-height: 1.5;
    }
    button {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 12px 0;
      font-size: 1.05rem;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      box-shadow: 0 2px 8px rgba(34,158,217,0.07);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 7px;
      transition: background 0.18s, box-shadow 0.18s;
    }
    button:active {
      background: var(--accent-dark);
      box-shadow: 0 1px 2px rgba(34,158,217,0.10);
    }
    .star {
      width: var(--star-size);
      height: var(--star-size);
      display: inline-block;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <h1>Магазин цифровых товаров</h1>
  <div id="list"></div>

  <script>
    const tg     = window.Telegram?.WebApp;
    const listEl = document.getElementById('list');

    // Загружаем каталог
    fetch('catalog.json')
      .then(r => r.json())
      .then(data => render(data.products));

    function render(products) {
      products.forEach(p => {
        const card     = document.createElement('div');
        card.className = 'card';

        card.innerHTML = `
          <div class="title">${p.title}</div>
          <div class="desc">${p.description}</div>
          <button onclick="buy('${p.id}')">
            Купить за ${p.price_stars}
            <span class="star">${starSVG()}</span>
          </button>
        `;
        listEl.appendChild(card);
      });
    }

    // Покупка через serverless хук
    async function buy(productId) {
      try {
        const response = await fetch(`https://functions.yandexcloud.net/d4e8d2h199cdcsnfhai7?item=${productId}`);
        const data = await response.json();
        
        if (data.invoiceLink) {
          tg.openInvoice(data.invoiceLink);   // открывает drawer оплаты в Telegram
        } else {
          tg.showAlert('Ошибка создания счета: ' + (data.error || 'Неизвестная ошибка'));
        }
      } catch (e) {
        tg.showAlert('Ошибка: ' + e.message);
      }
    }

    // SVG-иконка звезды Telegram
    function starSVG() {
      return `
        <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="svg-mbw4urwefurpuem9ryc-gradient1" x1="10" y1="1.5" x2="10" y2="18.5" gradientUnits="userSpaceOnUse">
              <stop stop-color="#FFD600"/>
              <stop offset="1" stop-color="#FFB800"/>
            </linearGradient>
          </defs>
          <path d="M7.26843 6.25162L9.28943 2.22541C9.52311 1.76121 10.0884 1.5749 10.5494 1.80857C10.7294 1.90015 10.8747 2.04857 10.9662 2.23172L12.8767 6.11583C13.0314 6.43477 13.3378 6.64951 13.6883 6.69056L17.6829 7.17055C18.2261 7.23686 18.6145 7.73264 18.5513 8.27894C18.5229 8.50314 18.4218 8.71156 18.2608 8.86945L15.0998 11.9862C14.9703 12.1125 14.9103 12.2894 14.9324 12.4694L15.4598 16.6756C15.5356 17.2787 15.1093 17.8282 14.5093 17.904C14.2819 17.9324 14.0546 17.8913 13.8525 17.7808L10.5147 15.9556C10.2715 15.823 9.98099 15.8198 9.73784 15.9461L6.27687 17.7208C5.79057 17.9703 5.1969 17.7745 4.94743 17.285C4.8527 17.1019 4.82112 16.8966 4.84954 16.6945L5.12427 14.7619C5.26006 13.8177 5.84425 12.9967 6.69055 12.5641L10.5305 10.6031C10.6315 10.5526 10.6726 10.4263 10.622 10.322C10.581 10.2431 10.4957 10.1957 10.4073 10.2084L5.70847 10.8841C4.99164 10.9852 4.26535 10.7831 3.7001 10.322L2.13698 9.04629C1.69173 8.68314 1.6191 8.02 1.98225 7.57159C2.15277 7.36317 2.39592 7.22739 2.66118 7.19265L6.6716 6.67793C6.92739 6.64319 7.15159 6.4853 7.26843 6.25162Z" fill="url(#svg-mbw4urwefurpuem9ryc-gradient1)"/>
        </svg>
      `;
    }

    // Красим тулбар, если приложение открыто в Telegram
    tg?.ready?.();
    tg?.setHeaderColor?.('#0094ff');
    tg?.setBackgroundColor?.('#ffffff');
  </script>
</body>
</html>